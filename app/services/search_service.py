# app/services/search_service.py

from abc import ABC, abstractmethod
from typing import List, Dict, Any
import re


class BaseSearchService(ABC):
    """
    ูุงุฌูุฉ ูุฌุฑุฏุฉ ูุฎุฏูุฉ ุงูุจุญุซ ุฏุงุฎู ุงูู Knowledge Base.
    ูููู ูุงุญูุงู ุชูููุฐูุง ุจุงุณุชุฎุฏุงู:
    - Mock (In-Memory)
    - Azure AI Search
    - ElasticSearch
    - ุฃู ูุญุฑู ุจุญุซ ุขุฎุฑ
    """

    @abstractmethod
    def add_documents(self, kb_id: str, documents: List[str]):
        """
        ุฅุถุงูุฉ ูุณุชูุฏุงุช ุฌุฏูุฏุฉ ููุงุนุฏุฉ ูุนุฑูุฉ ูุนูููุฉ.

        :param kb_id: ูุนุฑู ุงูู Knowledge Base
        :param documents: ูุงุฆูุฉ ูุตูุต (Chunks / Documents)
        """
        pass

    @abstractmethod
    def search(self, query: str, kb_id: str, top_k: int = 3) -> List[Dict[str, Any]]:
        """
        ุงูุจุญุซ ุฏุงุฎู ุงูู Knowledge Base ูุฅุฑุฌุงุน ุฃูุถู ุงููุชุงุฆุฌ.

        :param query: ุงุณุชุนูุงู ุงููุณุชุฎุฏู
        :param kb_id: ูุนุฑู ุงูู Knowledge Base
        :param top_k: ุนุฏุฏ ุงููุชุงุฆุฌ ุงููุฑุงุฏ ุฅุฑุฌุงุนูุง
        :return: ูุงุฆูุฉ ูู ุงูููุงููุณ ุชุญุชูู ุนูู ุงููุต ูุงูู score
        """
        pass


class MockSearchService(BaseSearchService):
    """
    ุชูููุฐ ูุญูู (In-Memory) ุจุณูุท ูุฎุฏูุฉ ุงูุจุญุซุ ูุฎุตุต ููุชุทููุฑ ูุงูุงุฎุชุจุงุฑุงุช.

    ุงูุฎุตุงุฆุต:
    - ุชุทุจูุน ูุตูุต ุนุฑุจูุฉ (Normalization)
    - ุฅุฒุงูุฉ ูููุงุช ุงูุชููู (Arabic Stopwords)
    - ุญุณุงุจ Score ุจุณูุท ุจูุงุกู ุนูู ุชูุฑุงุฑ ุงููููุงุช
    - ูุงุนุฏุฉ ููุงุนุฏ ุฎุงุตุฉ ููู Demo (ุฑูุถ ุฃุณุฆูุฉ ูุนููุฉ ุจุฅุฑุฌุงุน ูุชุงุฆุฌ ูุงุฑุบุฉ)
    """

    # ูุงุฆูุฉ ูููุงุช ุงูุชููู ุงูุนุฑุจูุฉ (Stopwords) - ูุงุจูุฉ ููุชูุณูุน
    ARABIC_STOPWORDS = {
        "ูู", "ูู", "ุนูู", "ุงูู", "ุฅูู", "ุนู", "ูู", "ูู", "ูู", "ูู",
        "ูุฐุง", "ูุฐู", "ุฐูู", "ุชูู", "ูุง", "ูุงุฐุง", "ููุงุฐุง", "ููู", "ูู",
        "ูุงู", "ูุงูุช", "ูููู", "ูุน", "ุซู", "ููุง", "ูุฏ", "ููุฏ", "ุจู",
        "ุฃู", "ู", "ูุง", "ุฅู", "ุฃู", "ุฅูู", "ุฃููุง", "ููุงู", "ููุง"
    }

    # ููุงุถูุน ููููุนุฉ (ุฎุงุตุฉ ุจุงูู Demo / ุงูุชูููู) ูุฌุจุฑ ุงููุธุงู ุนูู ุฑูุถูุง
    FORBIDDEN_TOPICS = {
        "ุฌุงุฐุจูุฉ",
        "ูุฑูุณุง",
        "ูุตูุฏุฉ",
        "ูุฑูุฎ",
        "ููุชุฉ",
    }

    def __init__(self):
        # ุงูุจููุฉ: {kb_id: [{"raw": "...", "norm": "..."}]}
        self.store: Dict[str, List[Dict[str, str]]] = {}

    # -----------------------------
    # ๐ค Arabic Normalization
    # -----------------------------
    def _normalize_arabic(self, text: str) -> str:
        """
        ุชุทุจูุน ุงููุต ุงูุนุฑุจู ูุฌุนูู ููุงุณุจุงู ูููุทุงุจูุฉ ุงูุจุณูุทุฉ.

        ุงูุฎุทูุงุช:
        - ุฅุฒุงูุฉ ุงูุชุดููู
        - ุชูุญูุฏ ุงูุฃูู (ุฃุ ุฅุ ุข โ ุง)
        - ุชุญููู ุงูุชุงุก ุงููุฑุจูุทุฉ ุฅูู ู
        - ุชุญููู ุงูุฃูู ุงูููุตูุฑุฉ ุฅูู ู
        - ุฅุฒุงูุฉ ุงูุฑููุฒ ุบูุฑ ุงูุนุฑุจูุฉ/ุงูุฃุฑูุงู/ุงููุณุงูุงุช
        """
        if not text:
            return ""

        # ุฅุฒุงูุฉ ุงูุชุดููู
        text = re.sub(r'[\u064B-\u065F]', '', text)

        # ุชูุญูุฏ ุงูุฃูู
        text = re.sub(r'[ุฃุฅุข]', 'ุง', text)

        # ุชุญููู ุงูุชุงุก ุงููุฑุจูุทุฉ ุฅูู ู
        text = re.sub(r'ุฉ', 'ู', text)

        # ุชุญููู ุงูุฃูู ุงูููุตูุฑุฉ ุฅูู ู
        text = re.sub(r'ู', 'ู', text)

        # ุงุณุชุจุฏุงู ุฃู ุดูุก ุบูุฑ ุญุฑูู ุนุฑุจูุฉ/ุฃุฑูุงู/ูุณุงูุงุช ุจูุณุงูุฉ
        text = re.sub(r'[^ุก-ู0-9 ]+', ' ', text)

        # ุฅุฒุงูุฉ ุงููุณุงูุงุช ุงูุฒุงุฆุฏุฉ
        text = re.sub(r'\s+', ' ', text).strip()

        return text

    # -----------------------------
    # ๐ฅ ุฅุถุงูุฉ ุงููุณุชูุฏุงุช
    # -----------------------------
    def add_documents(self, kb_id: str, documents: List[str]):
        """
        ุฅุถุงูุฉ ูุณุชูุฏุงุช ุฅูู KB ูุญุฏุฏุฉุ ูุน ุชุฎุฒูู ุงููุณุฎุฉ ุงูุฃุตููุฉ ูุงููุทุจูุนุฉ.

        :param kb_id: ูุนุฑู ุงูู Knowledge Base
        :param documents: ูุงุฆูุฉ ูุตูุต (Chunks)
        """
        if kb_id not in self.store:
            self.store[kb_id] = []

        for doc in documents:
            norm = self._normalize_arabic(doc)
            self.store[kb_id].append({
                "raw": doc,
                "norm": norm,
            })

    # -----------------------------
    # ๐ ุนูููุฉ ุงูุจุญุซ
    # -----------------------------
    def search(self, query: str, kb_id: str, top_k: int = 3) -> List[Dict[str, Any]]:
        """
        ุจุญุซ ุจุณูุท ุฏุงุฎู ุงูู KB:
        - ุชุทุจูุน ุงูุงุณุชุนูุงู
        - ุฑูุถ ููุงุถูุน ููููุนุฉ (ุฎุงุต ุจู Demo)
        - ุฅุฒุงูุฉ ูููุงุช ุงูุชููู ูุงููููุงุช ุงููุตูุฑุฉ
        - ุญุณุงุจ score ุจูุงุกู ุนูู ุชูุฑุงุฑ ุงููููุงุช ูู ูู chunk

        :param query: ุงุณุชุนูุงู ุงููุณุชุฎุฏู
        :param kb_id: ูุนุฑู ุงูู Knowledge Base
        :param top_k: ุนุฏุฏ ุงููุชุงุฆุฌ ุงููุฑุงุฏ ุฅุฑุฌุงุนูุง
        :return: ูุงุฆูุฉ ูู ุงููุชุงุฆุฌ: [{"text": "...", "score": 3}, ...]
        """

        # 1) ุงูุชุญูู ูู ูุฌูุฏ ูุงุนุฏุฉ ุงููุนุฑูุฉ
        if kb_id not in self.store:
            return []

        # 2) ุชุทุจูุน ุงูุงุณุชุนูุงู
        normalized_query = self._normalize_arabic(query)

        # 3) ูุงุนุฏุฉ ุงูู Demo: ุฑูุถ ุงูุฃุณุฆูุฉ ุงูุฎุงุฑุฌุฉ ุนู ูุทุงู ุงูู KB
        #    ุฅุฐุง ุงุดุชูู ุงูุงุณุชุนูุงู (ุจุนุฏ ุงูุชุทุจูุน) ุนูู ุฃู ูู ุงูููุงุถูุน ุงูููููุนุฉุ
        #    ููุฑุฌุน ูุงุฆูุฉ ูุงุฑุบุฉุ ููุง ูุฏูุน ุทุจูุฉ ุงูู API ูุฅุฑุฌุงุน status="rejected"
        if any(topic in normalized_query for topic in self.FORBIDDEN_TOPICS):
            return []

        # 4) ุชุฌููุฒ ูููุงุช ุงูุงุณุชุนูุงู:
        #    - ุชูุณูู ุฅูู ูููุงุช
        #    - ุฅุฒุงูุฉ ูููุงุช ุงูุชููู
        #    - ุชุฌุงูู ุงููููุงุช ุฐุงุช ุงูุทูู <= 2
        query_words = {
            w
            for w in normalized_query.split()
            if len(w) > 2 and w not in self.ARABIC_STOPWORDS
        }

        # ุฅุฐุง ูู ูุชุจููู ุฃู ูููุฉ ุฐุงุช ูุนููุ ููุง ุฏุงุนู ููุจุญุซ
        if not query_words:
            return []

        results: List[Dict[str, Any]] = []

        # 5) ุงูุจุญุซ ุฏุงุฎู ูู chunk
        for item in self.store[kb_id]:
            chunk_text = item["raw"]
            chunk_norm = item["norm"]

            score = 0

            # ุญุณุงุจ ุนุฏุฏ ูุฑุงุช ุธููุฑ ูู ูููุฉ ูู ุงูุงุณุชุนูุงู ุฏุงุฎู ุงููุต
            for word in query_words:
                if not word:
                    continue
                # count ูุนุทู ุนุฏุฏ ูุฑุงุช ุธููุฑ ุงููููุฉ (ูุทุงุจูุฉ ุจุณูุทุฉ)
                score += chunk_norm.count(word)

            # ููุท ูุถูู ุงููุชุงุฆุฌ ุงูุชู ุญุตูุช ุนูู score > 0
            if score > 0:
                results.append({
                    "text": chunk_text,
                    "score": score,
                })

        # 6) ุชุฑุชูุจ ุงููุชุงุฆุฌ ุญุณุจ score ุชูุงุฒููุงู
        results.sort(key=lambda x: x["score"], reverse=True)

        # 7) ุฅุฑุฌุงุน ุฃูุถู top_k ูุชูุฌุฉ
        return results[:top_k]
